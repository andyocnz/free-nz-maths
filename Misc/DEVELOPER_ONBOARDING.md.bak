# Developer Onboarding ‚Äì free-nz-maths (Phase 7‚Äì12 overview)

This is a comprehensive guide for adding new question templates and understanding the codebase structure. Updated with learnings from Phase 12 (37 templates fixed).

## üöÄ Quick Start: Adding New Templates (5 Minutes)

**Want to add templates quickly and correctly?** Follow this streamlined workflow:

### Step 1: Create Your Template JSON
Use examples from `TEMPLATE_EXAMPLES.md` or start with this basic structure:

```json
{
  "id": "Y6.N.MY_SKILL.T1",
  "stem": "Question text with {param}",
  "params": {
    "param": ["int", 1, 10]
  },
  "answer": "param * 2",
  "difficulty": 5
}
```

### Step 2: Validate It
```bash
# Catches 90% of issues before you add it!
node scripts/validate_template.cjs '{"id":"Y6.N.MY_SKILL.T1",...}'
```

The validator checks for:
- ‚úÖ Missing `{}` around expressions with x/y
- ‚úÖ Backticks or `${}` template literal syntax
- ‚úÖ Variable prefixes students shouldn't type
- ‚úÖ Missing parameters
- ‚úÖ Division by zero risks
- ‚úÖ Invalid parameter formats

### Step 3: Add to curriculumDataNew.json
1. Find the right year and skill in `src/curriculumDataNew.json`
2. Add your template to the `templates` array
3. **IMPORTANT - Phase Numbering:** Use the same phase number for all templates added in one batch
   - **All templates added in the same batch should use the SAME phase number**, regardless of year level
   - Example: If adding templates for Years 6, 7, and 13 together, use `"phase": 10.6` for ALL of them
   - This makes filtering easier in dev mode (`?dev&phase=10.6` shows all templates from that batch)
   - Use incremental phase numbers for different batches: `10.1`, `10.2`, `10.3`, etc.
   - Example:
   ```json
   // Year 6 template in batch 10.6
   {
     "id": "Y6.M.MEASUREMENT",
     "phase": 10.6,
     "templates": [...]
   }

   // Year 13 template in SAME batch 10.6
   {
     "id": "Y13.L.LOGARITHMS",
     "phase": 10.6,
     "templates": [...]
   }
   ```
4. Validate JSON syntax:
   ```powershell
   Get-Content src/curriculumDataNew.json | ConvertFrom-Json | Out-Null
   ```

### Step 4: Test It
```bash
# Generate sample question
npm run dev
# Then navigate to your skill in the UI

# OR use the sample generator
node scripts/sample_generate.mjs | Select-String "Y6.N.MY_SKILL"
```

### Common Issues Quick Reference

| Issue | Example | Fix |
|-------|---------|-----|
| **Missing {}** | `"answer": "x + y"` | `"answer": "{x + y}"` |
| **Backticks** | `` "answer": "`x=${a}`" `` | `"answer": "x={a}"` |
| **Variable prefix** | `"answer": "v = {value}"` | `"answer": "{value}"` |
| **No rounding** | `"answer": "{a/b}"` | `"answer": "{round(a/b, 2)}"` |
| **Div by zero** | `["int", -5, 5]` with `/x` | Use `["int", 1, 10]` or conditional |
| **Static answer quotes** | `"answer": "'x ‚â§ 4'"` (params: {}) | `"answer": "x ‚â§ 4"` (NO quotes!) |
| **Decimal phase conflict** | `"phase": 10.10` = 10.1 | Use `"phase": 10.11` instead |
| **Hardcoded calculation** | `"params": {}` with no visualData | Add params OR visualData! |
| **visualData mismatch** | Static visual with randomized params | Reference params OR split templates |

#### ‚ö†Ô∏è Critical: Static Answers (No Parameters)

When a template has **no parameters** (`"params": {}`), the answer is a **static string**:

```json
// ‚ùå WRONG - Shows quotes in the answer
{
  "stem": "Solve the inequality: ‚àí2x + 7 ‚â• 15.",
  "params": {},
  "answer": "'x ‚â§ ‚àí4'"  // ‚ùå Displays as: 'x ‚â§ ‚àí4'
}

// ‚úÖ CORRECT - No quotes around the static answer
{
  "stem": "Solve the inequality: ‚àí2x + 7 ‚â• 15.",
  "params": {},
  "answer": "x ‚â§ ‚àí4"  // ‚úÖ Displays as: x ‚â§ ‚àí4
}
```

**Why?** The template engine treats the entire answer value as a literal string when there are no parameters. Adding quotes makes them part of the displayed answer.

#### ‚ö†Ô∏è Critical: Phase Numbering with Decimals

**JavaScript decimal quirk:** `10.10` equals `10.1` (decimal), NOT "10 point 10"!

```json
// ‚ùå WRONG - Conflicts with phase 10.1
"phase": 10.10  // This is actually 10.1 in decimal!

// ‚úÖ CORRECT - Use 10.11, 10.12, etc.
"phase": 10.11  // This is unique and won't conflict
```

**Solution:** After phase 10.9, use `10.11`, `10.12`, `10.13`, etc. (skip 10.10, 10.20, etc.)

**Rounding Division Results:** Always round division to avoid long decimals in inequality answers:

```json
// ‚ùå Shows: x ‚â• 0.6666666666666
"answer": "{'x ‚â• ' + (b - c) / a}"

// ‚úÖ Shows: x ‚â• 0.67
"answer": "{'x ‚â• ' + round((b - c) / a, 2)}"
```

#### üö´ CRITICAL: Never Hardcode Calculation Questions

**Templates with `"params": {}` are ONLY allowed if they have `visualData` and require visual interpretation.**

**Why?** Students will memorize hardcoded answers instead of learning the concept. This defeats the purpose of a practice platform.

```json
// ‚ùå NEVER - Pure calculation with no params
{
  "id": "Y9.A.EQUATIONS.T1",
  "stem": "Solve 2x + 5 = 15",
  "params": {},  // ‚ùå No parameters!
  "answer": "5"  // Students will memorize this after one try!
}

// ‚úÖ CORRECT - Randomized calculation
{
  "id": "Y9.A.EQUATIONS.T1",
  "stem": "Solve {a}x + {b} = {c}",
  "params": {
    "a": ["int", 1, 5],
    "b": ["int", 1, 10],
    "c": ["int", 10, 30]
  },
  "answer": "(c - b) / a"  // ‚úÖ Different every time!
}

// ‚úÖ ALSO OK - Visual interpretation (not calculation)
{
  "id": "Y6.S.STEM_AND_LEAF.T3",
  "stem": "What is the smallest value in the stem-and-leaf plot?",
  "params": {},  // ‚úÖ OK because it has visualData
  "answer": "22",
  "visualData": {  // ‚úÖ Student must read from diagram
    "type": "stem_and_leaf",
    "stems": [2, 3, 4, 5],
    "leaves": {"2": [2, 5], "3": [0, 8, 9], "4": [1], "5": [2]}
  }
}
```

**Audit Results:**
- ‚úÖ **13 acceptable** hardcoded templates (all have `visualData`)
- ‚ùå **4 unacceptable** hardcoded templates (pure calculation, need fixing)
- See `HARDCODED_TEMPLATES_AUDIT.md` for full list

**Rule of thumb:** If a student can solve it with pencil & paper (no visual), it MUST have randomized parameters!

---

#### üé® CRITICAL: visualData Must Match Randomized Params

**When using `visualData`, the visualization MUST match the randomized question parameters!**

**Common Mistake**: Using static visualData with randomized question parameters causes students to see mismatched visuals.

```json
// ‚ùå WRONG - Mismatch between params and visualData
{
  "id": "Y8.S.SCATTER_PLOTS.T1",
  "stem": "What correlation does {scenario} show?",
  "params": {
    "scenario": ["choice",
      ["hours studied vs scores (positive)", "Positive"],
      ["TV hours vs scores (negative)", "Negative"]  // Different correlations!
    ]
  },
  "visualData": {
    "type": "scatter_plot",
    "points": [[1,40],[2,50],[3,60]]  // ‚ùå Always upward trend - WRONG for negative!
  }
}
```

**‚úÖ Solution 1: Reference params in visualData**
```json
{
  "id": "Y8.G.TRANSFORMATIONS.T1",
  "stem": "Reflect point ({x},{y}) across y-axis",
  "params": { "x": ["int", 1, 10], "y": ["int", 1, 10] },
  "visualData": {
    "type": "coordinate_grid",
    "points": [["x","y"]]  // ‚úÖ String references to param names!
  }
}

// Other examples:
"visualData": {
  "values": ["v1", "v2", "v3"],        // Histogram values
  "matrix1": [["a","b"],["c","d"]],     // Matrix entries
  "baseArea": "a",                       // Single value
  "height": "h"
}
```

**‚úÖ Solution 2: Split into separate templates**
```json
// T1: Only positive correlations
{
  "id": "Y8.S.SCATTER_PLOTS.T1",
  "params": {
    "scenario": ["choice",
      ["hours studied vs scores", "Positive"],
      ["advertising vs sales", "Positive"]
    ]
  },
  "visualData": { "points": [[1,40],[2,50],[3,60]] }  // ‚úÖ Upward
},

// T2: Only negative correlations
{
  "id": "Y8.S.SCATTER_PLOTS.T2",
  "params": {
    "scenario": ["choice",
      ["TV hours vs scores", "Negative"],
      ["car age vs value", "Negative"]
    ]
  },
  "visualData": { "points": [[1,60],[2,50],[3,40]] }  // ‚úÖ Downward
}
```

**‚úÖ Solution 3: Static visual for interpretation**
```json
{
  "stem": "What is the smallest value in the stem-and-leaf plot?",
  "params": {},  // ‚úÖ Empty params = OK with static visual
  "answer": "22",
  "visualData": { "type": "stem_and_leaf", ... }
}
```

**Testing Checklist for visualData:**
- [ ] Does the template have randomized params?
- [ ] If YES: Does visualData reference param names OR is it split by scenario type?
- [ ] Test 5-10 times: Does the visual match the question every time?
- [ ] For choice params: Do all choices work with the SAME visual OR split into separate templates?

**See `VISUALDATA_AUDIT.md` for comprehensive examples and audit results.**

**üìñ See TEMPLATE_EXAMPLES.md for complete patterns and examples.**

---

This is a short working guide so a junior dev can pick up where the recent Phase 7‚Äì12 changes left off (curriculum extensions, NCEA trials, SEO, and group test mode).

## Quick setup (Windows PowerShell)
- Ensure Node.js (LTS) and npm are installed.
- From the project root (`c:\Users\Andy\free-nz-maths`):

```powershell
# install deps
npm install

# run dev server (Vite)
npm run dev
# if port 5173 is in use Vite will try another port (e.g., 5174)

# build for production
npm run build

# run local sample generator (prints sample question objects)
node .\scripts\sample_generate.mjs
```

Open the local dev URL shown by Vite (e.g. `http://localhost:5173/` or `http://localhost:5174/`) to view the app.

## Files you should know (most-relevant)
- `src/curriculumDataFull.json` ‚Äì audited/base curriculum (do not modify directly when adding new Phase content).
- `src/curriculumDataNew.json` ‚Äì Phase 7+ additions and editable new templates. New templates live here and are merged at runtime.
- `src/curriculumDataMerged.js` ‚Äì runtime merging logic that appends `curriculumDataNew` into the base and marks appended templates with `isNew`.
- `src/templateEngine.js` ‚Äì template parameter generation, answer expression evaluation, and `visualData` token substitution. Edit here when you need new param generators or answer normalization.
- `src/QuestionVisualizer.jsx` ‚Äì HTML5 Canvas rendering routines for all visuals. Key functions:
  - `drawNet(ctx, data)` ‚Äì draws nets. (Extended to support `shape_type`: `cube`, `rectangular_prism`, `triangular_prism`, `square_pyramid`, `tetrahedron`).
  - `drawParallelTransversal`, `drawHistogram`, etc. ‚Äì other visuals.
- `src/HintModal.jsx` ‚Äì hint modal component. Accepts `htmlContent` for rich (SVG/HTML) hints.
- `src/KnowledgeModal.jsx` ‚Äì ‚ÄúRemind me the knowledge‚Äù modal that shows concept summaries from `src/knowledgeSnippets.json`. It is scrollable and sized larger than the hint modal.
- `src/App.jsx` ‚Äì app logic (hint generation, wiring, question lifecycle), NCEA trial wiring, SEO titles/meta descriptions, and the IXL-alternative landing page.
- `scripts/sample_generate.mjs` ‚Äì quick node script that uses the template engine to print sample questions (useful for automated checks without running the browser).

### NCEA past papers & trials (Phase 9)
- `pastpapers/ncea_legacy_papers_structured.json` ‚Äì structured Level 1 **legacy** externals (91027, 91028, 91031 etc).
- `pastpapers/ncea_new_papers_structured.json` ‚Äì structured Level 1 **revised** standards (e.g. 91946, 91947).
- `pastpapers/NewFrom2024.json` ‚Äì source of the clean 2025 91947 structure; used to normalise the 91947 entry.
- `pastpapers/resources/**` ‚Äì local exam/resource PDFs and diagrams (e.g. `pastpapers/resources/2025/91947/3a.webp`, `pastpapers/resources/91946-res-2025.pdf`).
- `src/nceaStructuredData.js` ‚Äì normalises NCEA JSON into a flat question list and exposes `buildNceaTrialQuestionsForStandard(standardNumber)` used by the trial engine.
- `src/nceaResources.js` ‚Äì resolves `local:pastpapers/resources/...` paths (both PDF and WEBP/PNG) to Vite URLs via `import.meta.glob`.
- `src/PastPapersIndex.jsx` ‚Äì UI for the NCEA Trial Exams section (legacy vs revised tabs, standard/year selection, and hooks for starting trials).

To see the NCEA trial index locally, you can use `/?mode=ncea-index` or navigate via the "NCEA Trial Exams" block on the landing page. Trial questions are built from the structured JSON (fixed questions for now; randomisation is a future phase).

### Group Test Mode (Phase 12)
Phase 12 introduces deterministic group testing where teachers create tests with 7-digit codes and students get identical questions.

#### Key Files
- `src/groupTestEngine.js` ‚Äì deterministic question generation using seeded RNG. Every student with the same code gets identical questions in identical order.
- `src/config.js` ‚Äì Google Apps Script URLs for registry and scores storage.
- `src/googleApi.js` ‚Äì API functions for interacting with Google Sheets backend.
- `phase/phase12 - group test.md` ‚Äì full specification for group test mode.

#### Google Sheets Backend
Two sheets are required:
1. **GroupRegistry** (`REGISTRY_URL`) ‚Äì stores test metadata (groupCode, teacherEmail, teacherPin, year, mode, totalQuestions)
2. **GroupScores** (`SCORES_URL`) ‚Äì stores student results (groupCode, studentName, score, wrongQuestions, etc.)

Apps Script endpoints handle POST (submit data) and GET (retrieve data) operations.

#### How Group Tests Work
1. Teacher fills form at `/group-test-setup` ‚Üí generates 7-digit code
2. Data POSTed to `REGISTRY_URL` with mode encoded as:
   - `"full"` ‚Äì all topics for the year
   - `"focused:SKILL_ID"` ‚Äì single topic only (e.g., `"focused:Y7.N.FRACTIONS_ADD"`)
3. Students visit `/?group=7482915` ‚Üí app fetches registry entry ‚Üí generates deterministic test
4. `groupTestEngine.js` uses the group code as seed ‚Üí all students get same questions
5. On submit, results POSTed to `SCORES_URL`
6. Teacher views results at `/results?group=7482915&pin=1234`

#### Focused Mode (Phase 12 Feature)
Teachers can select a single topic instead of testing all topics:
- UI: Mode dropdown with "Full assessment" or "Focused on one topic"
- When "Focused" is selected, a searchable dropdown appears with all skills for that year
- Skills grouped by strand and sorted alphabetically
- Mode stored as `focused:SKILL_ID` in the existing `mode` column (no new sheet columns)
- `groupTestEngine.js` filters to only the selected skill when generating questions

#### Answer Hiding (Phase 12 Feature)
To prevent answer sharing between students:
- **Students** see "Wrong ‚ùå" without the answer shown
- **Teachers** add `&dev=true` to URL to see answers for debugging
- Regular (non-group) tests always show answers
- Implementation: checks `isGroupMode && !isDevMode` before displaying answers

#### Testing Group Mode Locally
```powershell
# Create a test at:
http://localhost:5173/

# Navigate to "Group Test Setup" and create a code
# Then open student link:
http://localhost:5173/?group=1234567

# View results (teacher):
http://localhost:5173/results?group=1234567&pin=1234

# Debug mode (see answers):
http://localhost:5173/?group=1234567&dev=true
```

### SEO & site structure (Phase 9.1)
- `src/App.jsx` (top-level `useEffect`) ‚Äì sets `document.title` and the main `<meta name="description">` dynamically based on current mode, selected skill, and active NCEA paper.
- `src/App.jsx` ‚Äì also handles a dedicated `/ixl-alternative` virtual page (‚ÄúA Free Alternative to IXL for NZ Maths Practice‚Äù) with comparison table and copy.
- `scripts/generate_sitemap.mjs` ‚Äì Node script that merges `curriculumDataFull.json` + `curriculumDataNew.json` and generates `sitemap.xml` (root) with routes like `/`, `/ixl-alternative`, `/topics/<skillId>`.

When adjusting SEO behaviour, keep changes minimal and avoid breaking the SPA routing ‚Äì we still rely on client-side navigation for most paths.

## Template Engine & Answer Expression Guide

This section documents critical knowledge about how the template engine evaluates answer expressions, common pitfalls, and fixes from Phase 12.

### How Answer Evaluation Works

The template engine (`src/templateEngine.js`) evaluates answer expressions in two paths:

1. **Pure Expression Path** (line 709): For numeric/probability expressions without curly braces or algebraic variables
   - Uses `evaluateAnswer()` function
   - Creates a JavaScript function with parameter context
   - Evaluates and returns the result

2. **Display Template Path** (line 711-740): For answers with `{placeholders}` or algebraic syntax
   - Replaces `{param}` placeholders with values
   - Used for formatted answers like coordinates `({x}, {y})`

**Detection Logic** (line 707):
```javascript
const looksAlgebraic = /(?<![=!<>])=(?!=)/.test(rawAnswer) || /\bx\b/.test(rawAnswer) || /\by\b/.test(rawAnswer)
```

This regex checks for:
- Assignment operator `=` (but NOT comparison `===`, `==`, `!=`)
- Algebraic variables `x` or `y` as standalone words

### Answer Expression Best Practices

#### ‚úÖ DO Use These Patterns

**Simple arithmetic:**
```javascript
"answer": "a + b"
"answer": "a * b / c"
"answer": "round(a / b, 2)"
```

**Ternary operators (for conditional logic):**
```javascript
"answer": "(x > 0 ? 'Positive' : 'Negative')"
"answer": "(param === 'key1' ? v1 : param === 'key2' ? v2 : v3)"
```

**Function calls from mathHelpers:**
```javascript
"answer": "simplify(a*d + b*c, b*d)"
"answer": "volume_rectangular_prism(l, w, h)"
```

**String literals (with proper escaping):**
```javascript
"answer": "'Cube'"  // Single quotes inside double quotes
"answer": "\"Rectangle\""  // Escaped double quotes
```

#### ‚ùå DON'T Use These Patterns

**Object literals with curly braces:**
```javascript
// ‚ùå BAD - Curly braces confuse the parser
"answer": "({\"key1\": v1, \"key2\": v2})[param]"

// ‚úÖ GOOD - Use ternary chain instead
"answer": "(param === 'key1' ? v1 : param === 'key2' ? v2 : v3)"
```

**Assignment operators:**
```javascript
// ‚ùå BAD - Will be treated as algebraic and skip evaluation
"answer": "x = a + b"

// ‚úÖ GOOD - Just return the value
"answer": "a + b"
```

**Complex array/object operations:**
```javascript
// ‚ùå BAD - Too complex for template engine
"answer": "[v1, v2, v3].map(x => x * 2)[index]"

// ‚úÖ GOOD - Pre-calculate or use simple ternary
"answer": "(index === 0 ? v1*2 : index === 1 ? v2*2 : v3*2)"
```

### Case Study: Histogram Answer Fix

**Original Problem** (curriculumDataNew.json line 82):
```javascript
"answer": "({\"130-140\": v1, \"140-150\": v2, \"150-160\": v3, \"160-170\": v4})[targetBinLabel]"
```

**What Went Wrong:**
1. Curly braces `{}` triggered the "display template" path
2. Expression wasn't evaluated - shown as raw string to user
3. Students saw: `Wrong ‚ùå Answer: ({"130-140": v1, "140-150": v2, ...})[targetBinLabel]`

**The Fix:**
```javascript
"answer": "(targetBinLabel === '130-140' ? v1 : targetBinLabel === '140-150' ? v2 : targetBinLabel === '150-160' ? v3 : v4)"
```

**Why It Works:**
- No curly braces - goes through pure expression path
- Comparison operators `===` allowed after regex update
- Properly evaluates to actual number (e.g., `7`)

**Template Engine Regex Update** (templateEngine.js line 707):
```javascript
// OLD - matched any '=' including comparisons
const looksAlgebraic = /=/.test(rawAnswer) || ...

// NEW - only matches assignment, not comparison
const looksAlgebraic = /(?<![=!<>])=(?!=)/.test(rawAnswer) || ...
```

### Testing Answer Expressions

**Quick test in browser console:**
```javascript
// Simulate the evaluation context
const params = { v1: 5, v2: 7, v3: 10, v4: 3, targetBinLabel: '140-150' }
const answer = "(targetBinLabel === '130-140' ? v1 : targetBinLabel === '140-150' ? v2 : targetBinLabel === '150-160' ? v3 : v4)"

// Use Function constructor like template engine does
const func = new Function(...Object.keys(params), `return ${answer}`)
console.log(func(...Object.values(params)))  // Should output: 7
```

**Using sample generator:**
```powershell
node .\scripts\sample_generate.mjs | Select-String "Y6.S.HISTOGRAMS"
```

This prints sample questions and their evaluated answers - useful for catching expression issues.

### Common Answer Expression Errors

**Error: "Wrong ‚ùå Answer: (expression...)"**
- **Cause**: Expression contains `{}` or failed to evaluate
- **Fix**: Rewrite without object literals, use ternary chains

**Error: Answer shows "0" for all questions**
- **Cause**: Exception during evaluation (check console)
- **Fix**: Verify all parameters exist, check function names match mathHelpers exports

**Error: Comparison operators not working**
- **Cause**: Old regex treated `===` as algebraic
- **Fix**: Already fixed in line 707 - ensure you have latest templateEngine.js

**Error: Template shows raw {param} in answer**
- **Cause**: Param name doesn't exist in context
- **Fix**: Check param name spelling matches exactly

### When to Use formattedAnswer

Some questions need special answer formatting (e.g., fractions shown as "3/4 ‚âà 0.75").

Set `formattedAnswer` in special handling code (templateEngine.js lines 740-770):
```javascript
formattedAnswer = mathHelpers.simplify(num, den) + ' ‚âà ' + (num/den).toFixed(6)
```

During answer checking, `formattedAnswer` is shown to users, but evaluation still uses the computed `answer`.

## How to add new question templates

**Recommended workflow** (uses validation tools):

1. **Write template** - Start with examples from `TEMPLATE_EXAMPLES.md`
2. **Validate** - Run `node scripts/validate_template.cjs '<json>'` to catch issues
3. **Add to file** - Add to `src/curriculumDataNew.json` under appropriate year/skill
4. **Test** - Use `npm run dev` or `node scripts/sample_generate.mjs`

### Template Structure
```json
{
  "id": "Y6.G.NETS.T8",
  "stem": "Which 3D solid is formed from the net shown?",
  "params": {},
  "answer": "'MyShapeName'",
  "difficulty": 3,
  "visualData": { "type": "net", "shape_type": "tetrahedron" }
}
```

### Key Rules (from 37 templates fixed in Phase 12)
1. **Use `{}` for expressions with x/y**: `"answer": "{x + y}"` not `"answer": "x + y"`
2. **No backticks**: Use `"x={a}"` not `` "`x=${a}`" ``
3. **No variable prefixes**: Use `"{2*a}x + {b}"` not `"f'(x) = {2*a}x + {b}"`
4. **Round divisions**: Use `"round(a/b, 2)"` not `"a/b"`
5. **Protect division by zero**: Use conditionals or avoid 0 in ranges

### Visual Data
Pick `visualData.type` to match a renderer in `QuestionVisualizer.jsx`:
- `net`, `histogram`, `parallel_transversal`, `scatter_plot`, `stem_and_leaf`
- `coordinate_grid`, `graph_parabola`, `triangle`, `circle`, `bar_chart`
- `pie_chart`, `box_plot`, `venn_diagram`, `fraction_visual`

### Parameter Types
- `["int", min, max]` - Random integer
- `["decimal", min, max, decimals]` - Random decimal (e.g., `["decimal", 0, 10, 2]`)
- `["choice", val1, val2, ...]` - Random selection

**Note**: New templates in `curriculumDataNew.json` are merged and marked `isNew` at runtime ‚Äì don't edit `curriculumDataMerged.js` unless you need to change merging behaviour.

**üìñ Full examples and patterns: see `TEMPLATE_EXAMPLES.md`**

## How to extend visuals
- Open `src/QuestionVisualizer.jsx` and find the `switch` on `visualData.type`. Add a case that calls a new `drawXxx` function.
- Implement the `drawXxx(ctx, data)` function. Keep drawings simple and avoid revealing answers in the visual. Use `data` fields rather than hard-coded numbers.
- For nets: edit `drawNet` and add support for new `shape_type` variants. Keep the function robust to missing fields.
- After modifying visuals, run the dev server and view affected questions in-browser, or run `node .\scripts\sample_generate.mjs` to see the `visualData` printed and ensure the correct `shape_type` is used.

## How hints & knowledge reminders work
- The app uses `HintModal.jsx` for per-question hints. Hints may be provided as plain text or as `htmlContent` containing inline SVG/HTML.
- ‚ÄúRemind me the knowledge‚Äù uses `KnowledgeModal.jsx` + `knowledgeSnippets.json` to show a short, scrollable concept recap with formulas and examples for the current skill.
- Both modals are opened from `App.jsx` ‚Äì search for `hintModal` and `knowledgeModal` usage to see where content is constructed.

## Testing & verification
- Use `node .\scripts\sample_generate.mjs` to generate and inspect sample questions quickly. The script prints `visualData` objects ‚Äì this is useful to confirm template IDs, params, and `visualData.type`/`shape_type` values.
- To verify visuals in-context: run `npm run dev`, open the site, navigate to Practice/Test pages and trigger the skill/topic that contains your templates.
- NCEA trials: use `/?mode=ncea-index`, choose a standard (e.g. 91947), and step through the trial to confirm diagrams/resources are wired correctly.

## Common tasks you may need to do
- Add synonyms for answers (e.g., accept both `Cuboid` and `Rectangular prism`): update `src/templateEngine.js` answer normalization or add multiple acceptable answer strings in the template (or extend the UI comparison to accept case-insensitive variations).
- Add new param generators (e.g., generate an array of points): extend `templateEngine.js` helpers and param types parsing.
- Improve artwork for a visual: update drawing code in `src/QuestionVisualizer.jsx` and watch for canvas scaling differences across sizes.
- Extend NCEA coverage: update `pastpapers/*.json`, re-run any helper scripts (e.g. `scripts/embed_91947_images.mjs`), and ensure new standards are surfaced in `PastPapersIndex.jsx` and `nceaStructuredData.js`.

## Commit / PR guidance
- Keep changes focused: one concept per PR (e.g., ‚ÄúAdd triangular prism nets‚Äù vs ‚ÄúRefactor visualizer‚Äù).
- Run `npm run build` or at least `node .\scripts\sample_generate.mjs` before opening a PR to catch syntax/runtime issues.
- Reference template IDs, NCEA standards, and pages changed in the PR description so reviewers know where to look (e.g. ‚Äúupdates 91947 Q2(b) diagram wiring‚Äù).

## Notes / Gotchas
- The template engine performs string substitution for `visualData` fields. If you put parameter names as strings in `visualData` (e.g., `"values": ["v1","v2"]`) the engine will replace those with actual numbers when generating a question.
- Canvas coordinates assume 400√ó300 by default. If adding a large/complex visual, use `visualData.canvasWidth` / `canvasHeight` to request a different canvas size.
- Hints and knowledge content may use `dangerouslySetInnerHTML` to render inline SVG/HTML ‚Äì review security/escaping if you accept external content.
- NCEA resource paths must start with `local:pastpapers/resources/...` so `nceaResources.js` can resolve them correctly via `import.meta.glob`.
- Group test registry lookups must always send both `groupCode` and the sanitized teacher PIN to the Google Apps Script endpoints (`getRegistry`, `fetchGroupScores`). The `/sample/index.html` and `/sample/registry-dump.html` tools already do this ‚Äì mirror that behaviour in `src/App.jsx` or the backend replies with "Incorrect teacher PIN or group code." even for valid pairs.

## Common Issues & Fixes (Phase 12)

### Answer Expression Issues
**Problem**: Template answer shows raw expression instead of evaluated result (e.g., `"Wrong ‚ùå Answer: (targetBinLabel === '130-140' ? v1 : ...)"`).

**Root Cause**: The template engine has logic to detect "algebraic" answers (line 707 in `templateEngine.js`) and skip evaluation. The regex `/=/` was matching comparison operators.

**Fix**: Avoid JavaScript object literal syntax `{...}` in answer expressions as curly braces confuse the parser. Use ternary chains instead:
```javascript
// ‚ùå DON'T use object literals
"answer": "({\"key1\": v1, \"key2\": v2})[param]"

// ‚úÖ DO use ternary chains
"answer": "(param === 'key1' ? v1 : param === 'key2' ? v2 : v3)"
```

The regex was updated to `/(?<![=!<>])=(?!=)/` to allow comparison operators while detecting assignment.

### Last Question Not Counted
**Problem**: When clicking "Finish Test" on the last question with an answer typed in, the answer is skipped and counted as wrong.

**Root Cause**: React state updates are asynchronous. Calling `checkAnswer()` then immediately reading `history` state gave stale data.

**Fix**: The `finishTest()` function now manually checks the answer inline and passes the updated history directly to `finishTestInternal(updatedHistory)` (lines 1296-1350 in `App.jsx`), avoiding async state timing issues.

### Grade Not Displaying
**Problem**: Test results show percentage (e.g., 80%) but no letter grade (should be A-).

**Root Cause**: The grade was only calculated for group mode tests (line 1324). Regular tests didn't have grade assignment.

**Fix**: Added a safeguard (lines 1327-1330) that ensures `gradeFromPercentage()` is called for all test types:
```javascript
if (!normalizedResults.grade) {
  normalizedResults.grade = gradeFromPercentage(normalizedResults.percentageScore)
}
```

### Total Questions Input Not Working
**Problem**: Cannot type in the "Total questions" field in group setup form.

**Root Cause**: Missing `sanitizeDigits` function that was being called but not defined.

**Fix**: Added the function (line 289 in `App.jsx`):
```javascript
const sanitizeDigits = (value, maxLength) => String(value || '').replace(/\D/g, '').slice(0, maxLength)
```

### Dev Mode for Debugging
Use `?dev=true` or `&dev=true` in the URL to:
- See answers in group tests (students normally see "Wrong ‚ùå" only)
- Access additional debugging features
- Test teacher-only functionality

Example: `http://localhost:5173/?group=1234567&dev=true`

---
Saved as `DEVELOPER_ONBOARDING.md` in the project root.
